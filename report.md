---
title: "RES - Labo 5 - HTTP Infrastrucutre"
author: 
	- "Christopher Meier"
	- "Daniel Palumbo"
date: "11 june 2017"

toc: true

geometry: "margin=1in"
---

# Introduction

# Step 1: Static HTTP server with apache httpd

The Dockerfile for this step is in the `docker/httpd-static` folder.

Because of its familiar configuration, we choose to use the php official docker image (with apache) `php:7.0-apache`. We used the default configuration (situated at `/etc/apache2/`), so our site is copied to the default website folder at `/var/www/html`.

The choosen bootstrap one page template is named *Stylish Portfolio*.

```sh
	docker build ./docker/httpd-static -t res/httpd-static
	docker run -d --name "httpd-static" -p 8080:80 res/httpd-static
```

After running these commands the static website will be available on the host of the docker container at the port 8080.

# Step 2: Dynamic HTTP server with express.js

The Dockerfile for this step is in the `docker/express-dynamic` folder.

This docker image is based on the version 4.4 of *node*'s official docker image. We copy the source file of our app to `/opt/app` and install its dependancy with `npm install`

Our app listen on the port `3000` and returns a list of 1 to 8 tuples of streetname and city. The streets and city name are generated by the module `Chance.js`.

```sh
	docker build ./docker/express-dynamic -t res/express-dynamic
	docker run -d --name "express-dynamic" -p 3000:3000 res/express-dynamic
```

After running these commands the JSON payload of the app can be accessed on the host of the docker container at the port 3000.

# Step 3: Reverse proxy with apache (static configuration)

The Dockerfile for this step is in the `docker/httpd-reverse-proxy` folder.

This image is based on the same image as the one from step1. The module `proxy` and `proxy_http` used in this step need the setting of some environment variables (to define some options). The configuration of available sites are copied to `/etc/apache2/sites-available`. The last action of the Dockerfile is to enable the needed module and the configured sites.

The reverse proxy is configured so that only request having `demo.res.local` as host are forwarded to the content providers; so the host name resolution of the client must be configured to resolve `demo.res.local` to the ip address of the host of the docker container.

This configuration use hardcoded ip address for its forwarding, therefore the docker environment must be cleaned up and the container must be started in the correct order.

```sh
	# Start step 1
	docker build ./docker/httpd-static -t res/httpd-static
	docker run -d --name "httpd-static" res/httpd-static

	# Start step 2
	docker build ./docker/express-dynamic -t res/express-dynamic
	docker run -d --name "express-dynamic" res/express-dynamic

	docker build ./docker/httpd-reverse-proxy -t res/httpd-reverse-proxy
	docker run -d --name "httpd-reverse-proxy" -p 8080:80 res/httpd-reverse-proxy
```

After running these commands and setting the host name resolution, the static site is available at `http://demo.res.local:8080/` and the JSON payload at `http://demo.res.local:8080/api/streets`.

# Step 4: AJAX requests with JQuery

* Copying `docker/httpd-static` to `docker/httpd-ajax` folder
* Cross-domain policy forbids an ajax query from querying a different domain.
* Load script `httpdoc/js/streets.js` from main page.
	* Ajax request every 2 sec.
	* Show from 1 to 8 street names and city in the *Streets* zone.

# Step 5: Dynamic reverse proxy configuration

* Copying `docker/httpd-reverse-proxy` to `docker/httpd-dynamic-reverse-proxy` folder
* Using environnement variable to pass ip addresses.
* Using sed to place ip addresses in conf file.
* Using script to place ips and start server.

OR

* Copying `docker/httpd-reverse-proxy` to `docker/httpd-dynamic-reverse-proxy-b` folder
* Using `--link` to specify dns name for container.
* Using dns name in place of ip for containers.

# Additionnal steps

* Using Traefik
    * Uses docker.socket
    * Uses docker labels for configuration

## Load balancing: multiple server nodes

* The naming of the backend ...

## Load balancing: round-robin vs sticky sessions

* An option enable or disable sticky sessions.

## Dynamic cluster management

* Traefik listen to the docker socket for starting and stopping events.

## Management UI

* Not implemented
